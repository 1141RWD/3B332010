<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Tactics</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <header>
            <div class="game-info">
                <div id="turnIndicator" class="turn-indicator turn-red">ç´…æ–¹å›åˆ</div>
                <div id="apCounter" class="ap-counter">AP: 6</div>
                <div id="victoryMessage" class="victory-message" style="display: none;"></div>
            </div>
            <div class="controls">
                <button class="btn-end-turn" onclick="endTurn()">çµæŸå›åˆ</button>
                <button class="btn-reset" onclick="resetGame()">é‡æ–°é–‹å§‹</button>
            </div>
        </header>

        <div class="game-area">
            <div class="board-container" style="position: relative;">
                <div id="gameBoard" class="game-board"></div>
                <svg id="attackRangeOverlay" width="100%" height="100%"></svg>
            </div>

            <div class="log-panel">
                <h3>æˆ°é¬¥ç´€éŒ„</h3>
                <div id="logContent" class="log-content"></div>
            </div>
        </div>
    </div>

    <script src="game-logic.js"></script>
    <script>
        const gameEngine = new GameEngine();
        let gameState = null;
        let selectedUnit = null;
        let selectedPos = null;
        let actionMode = null; // null, 'select_action', 'move', 'attack'
        let actionMenu = null;
        let mouseMoveHandler = null;
        let boardRect = null;

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            gameState = gameEngine.initGameState();
            renderBoard();
            updateUI();
            addLog('éŠæˆ²é–‹å§‹ï¼ç´…æ–¹å…ˆæ‰‹');
        }

        // æ¸²æŸ“æ£‹ç›¤
        function renderBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 13; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    const unit = gameState.board[`${x}_${y}`];

                    if (unit) {
                        if (unit.type === 'obstacle') {
                            cell.classList.add('obstacle');
                            cell.innerHTML = 'ğŸª¨';
                        } else {
                            cell.classList.add(unit.team + '-unit');

                            const unitType = document.createElement('div');
                            unitType.className = 'unit-type';
                            unitType.textContent = UNIT_NAMES[unit.type];

                            const unitHP = document.createElement('div');
                            unitHP.className = 'unit-hp';
                            unitHP.textContent = `${unit.hp}/${unit.max_hp}`;

                            const hpBar = document.createElement('div');
                            hpBar.className = 'hp-bar';
                            const hpFill = document.createElement('div');
                            hpFill.className = 'hp-fill';
                            hpFill.style.width = `${(unit.hp / unit.max_hp) * 100}%`;
                            hpBar.appendChild(hpFill);

                            cell.appendChild(unitType);
                            cell.appendChild(unitHP);
                            cell.appendChild(hpBar);
                        }
                    }

                    cell.onclick = () => handleCellClick(x, y);
                    board.appendChild(cell);
                }
            }
        }

        // è™•ç†æ ¼å­é»æ“Š
        async function handleCellClick(x, y) {
            if (gameState.game_over) {
                alert('éŠæˆ²å·²çµæŸï¼');
                return;
            }

            const unit = gameState.board[`${x}_${y}`];

            // ç§»å‹•æ¨¡å¼ï¼šé»æ“Šç¶ è‰²æ ¼å­ç§»å‹•ï¼Œå…¶ä»–å–æ¶ˆ
            if (actionMode === 'move') {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell.classList.contains('move-highlight')) {
                    await performMove(x, y);
                } else {
                    cancelAction();
                    addLog('å–æ¶ˆç§»å‹•');
                }
                return;
            }

            // æ”»æ“Šæ¨¡å¼ï¼šé»æ“Šç›®æ¨™æ”»æ“Šï¼Œå…¶ä»–å–æ¶ˆ
            if (actionMode === 'attack') {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell.classList.contains('attack-target')) {
                    await performAttack(x, y);
                } else {
                    cancelAction();
                    addLog('å–æ¶ˆæ”»æ“Š');
                }
                return;
            }

            // é»æ“Šå·±æ–¹å–®ä½ -> é¡¯ç¤ºæ“ä½œé¸å–®
            if (unit && unit.team === gameState.current_turn && unit.type !== 'obstacle') {
                selectedUnit = unit;
                selectedPos = { x, y };
                showActionMenu(x, y);
                addLog(`é¸æ“‡äº† ${unit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[unit.type]} (${x},${y})`);
                return;
            }

            // é»æ“Šå…¶ä»–åœ°æ–¹å–æ¶ˆé¸æ“‡
            if (selectedUnit || actionMode) {
                cancelAction();
            }
        }

        // é¡¯ç¤ºæ“ä½œé¸å–®
        function showActionMenu(x, y) {
            // åªæ¸…é™¤æ“ä½œç‹€æ…‹ï¼Œä¸æ¸…é™¤é¸ä¸­çš„å–®ä½ä¿¡æ¯
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }
            if (mouseMoveHandler) {
                document.removeEventListener('mousemove', mouseMoveHandler);
                mouseMoveHandler = null;
            }
            const svg = document.getElementById('attackRangeOverlay');
            if (svg) svg.innerHTML = '';
            document.querySelectorAll('.move-highlight, .attack-target').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target');
            });

            actionMode = 'select_action';
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // å‰µå»ºé¸å–®
            actionMenu = document.createElement('div');
            actionMenu.className = 'action-menu';

            const moveBtn = document.createElement('button');
            moveBtn.className = 'action-btn action-btn-move';
            moveBtn.textContent = 'ç§»å‹•';
            moveBtn.onclick = (e) => {
                e.stopPropagation();
                enterMoveMode();
            };

            const attackBtn = document.createElement('button');
            attackBtn.className = 'action-btn action-btn-attack';
            attackBtn.textContent = 'æ”»æ“Š';
            attackBtn.onclick = (e) => {
                e.stopPropagation();
                enterAttackMode();
            };

            actionMenu.appendChild(moveBtn);
            actionMenu.appendChild(attackBtn);

            // å®šä½é¸å–®
            const boardContainer = document.querySelector('.board-container');
            const cellRect = cell.getBoundingClientRect();
            const containerRect = boardContainer.getBoundingClientRect();

            actionMenu.style.left = (cellRect.left - containerRect.left + cellRect.width / 2 - 80) + 'px';
            actionMenu.style.top = (cellRect.top - containerRect.top - 50) + 'px';

            boardContainer.appendChild(actionMenu);
        }

        // é€²å…¥ç§»å‹•æ¨¡å¼
        function enterMoveMode() {
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            actionMode = 'move';

            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´å€‹æ£‹ç›¤ï¼‰
            document.querySelectorAll('.move-highlight, .attack-target, .selected').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target', 'selected');
            });

            const { x, y } = selectedPos;
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // è¨ˆç®—èŠ±è²»1APå¯é”çš„æ ¼å­
            const currentAP = gameState.current_turn === 'red' ? gameState.red_ap : gameState.blue_ap;
            const apMove = UNIT_STATS[selectedUnit.type].ap_move;

            if (currentAP < apMove) {
                addLog('APä¸è¶³ï¼Œç„¡æ³•ç§»å‹•');
                cancelAction();
                return;
            }

            let highlightCount = 0;

            // 1. é«˜äº®ç›¸é„°8æ ¼ï¼ˆåŸºæœ¬ç§»å‹•ï¼‰
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < 13 && ny >= 0 && ny < 15) {
                        const targetUnit = gameState.board[`${nx}_${ny}`];
                        // ç©ºæ ¼å¯ç§»å‹•ï¼ˆ1APï¼‰ï¼Œå‹æ–¹å¯äº¤æ›ï¼ˆéœ€2APä½†å…ˆé¡¯ç¤ºï¼‰
                        if (!targetUnit || (targetUnit.team === selectedUnit.team && targetUnit.type !== 'obstacle')) {
                            const targetCell = document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`);
                            if (targetCell) {
                                targetCell.classList.add('move-highlight');
                                highlightCount++;
                            }
                        }
                    }
                }
            }

            // 2. é«˜äº®è·³èºç§»å‹•ï¼ˆè·³åˆ°ç›´ç·šä¸Šé€£çºŒå‹æ–¹å–®ä½çš„å‰æ–¹ä¸€æ ¼ï¼Œæœ€å¤šè·³é3å€‹ï¼‰
            const jumpDirections = [
                { dx: 0, dy: 1, name: 'ä¸‹' },
                { dx: 0, dy: -1, name: 'ä¸Š' },
                { dx: 1, dy: 0, name: 'å³' },
                { dx: -1, dy: 0, name: 'å·¦' }
            ];

            for (let dir of jumpDirections) {
                // æ²¿è‘—é€™å€‹æ–¹å‘å°‹æ‰¾é€£çºŒçš„å‹æ–¹å–®ä½ï¼ˆæœ€å¤š3å€‹ï¼‰
                let consecutiveAllies = 0;
                let checkX = x + dir.dx;
                let checkY = y + dir.dy;

                // è¨ˆç®—é€£çºŒçš„å‹æ–¹å–®ä½æ•¸é‡ï¼ˆæœ€å¤š3å€‹ï¼‰
                while (checkX >= 0 && checkX < 13 && checkY >= 0 && checkY < 15 && consecutiveAllies < 3) {
                    const checkUnit = gameState.board[`${checkX}_${checkY}`];
                    if (checkUnit && checkUnit.team === selectedUnit.team && checkUnit.type !== 'obstacle') {
                        consecutiveAllies++;
                        checkX += dir.dx;
                        checkY += dir.dy;
                    } else {
                        break;
                    }
                }

                // å¦‚æœæœ‰é€£çºŒçš„å‹æ–¹å–®ä½ï¼Œè·³åˆ°ä»–å€‘çš„å‰æ–¹ä¸€æ ¼
                if (consecutiveAllies > 0) {
                    // checkX, checkY ç¾åœ¨å·²ç¶“æ˜¯æœ€å¾Œä¸€å€‹å‹æ–¹å–®ä½çš„ä¸‹ä¸€æ ¼
                    if (checkX >= 0 && checkX < 13 && checkY >= 0 && checkY < 15) {
                        const targetUnit = gameState.board[`${checkX}_${checkY}`];
                        // ç›®æ¨™ä½ç½®å¿…é ˆç‚ºç©º
                        if (!targetUnit) {
                            const targetCell = document.querySelector(`.cell[data-x="${checkX}"][data-y="${checkY}"]`);
                            if (targetCell && !targetCell.classList.contains('move-highlight')) {
                                targetCell.classList.add('move-highlight');
                                highlightCount++;
                            }
                        }
                    }
                }
            }

            addLog('ç§»å‹•æ¨¡å¼ï¼šé»æ“Šç¶ è‰²æ ¼å­ç§»å‹•ï¼ˆå«è·³èºï¼‰');
        }

        // é€²å…¥æ”»æ“Šæ¨¡å¼
        function enterAttackMode() {
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            actionMode = 'attack';

            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´å€‹æ£‹ç›¤ï¼‰
            document.querySelectorAll('.move-highlight, .attack-target, .selected').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target', 'selected');
            });

            const { x, y } = selectedPos;
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // æ›´æ–°æ£‹ç›¤rect
            const board = document.getElementById('gameBoard');
            boardRect = board.getBoundingClientRect();

            // æ·»åŠ é¼ æ¨™ç§»å‹•ç›£è½
            mouseMoveHandler = (e) => handleMouseMoveInAttackMode(e);
            document.addEventListener('mousemove', mouseMoveHandler);

            addLog('æ”»æ“Šæ¨¡å¼ï¼šç§»å‹•é¼ æ¨™ç„æº–ç›®æ¨™');
        }

        // è™•ç†æ”»æ“Šæ¨¡å¼ä¸‹çš„é¼ æ¨™ç§»å‹•
        function handleMouseMoveInAttackMode(e) {
            if (actionMode !== 'attack' || !selectedPos) return;

            // æ¯æ¬¡éƒ½é‡æ–°ç²å–boardRectï¼Œä»¥è™•ç†æ»¾å‹•
            const board = document.getElementById('gameBoard');
            boardRect = board.getBoundingClientRect();

            const { x, y } = selectedPos;
            const range = UNIT_STATS[selectedUnit.type].rng;

            // æª¢æ¸¬é¼ æ¨™ä¸‹çš„ç›®æ¨™æ ¼å­
            const cells = document.elementsFromPoint(e.clientX, e.clientY);
            const targetCell = cells.find(el => el.classList.contains('cell'));

            // æ¸…é™¤ä¹‹å‰çš„ç›®æ¨™é«˜äº®
            document.querySelectorAll('.attack-target').forEach(el => {
                el.classList.remove('attack-target');
            });

            let targetX = null;
            let targetY = null;

            if (targetCell) {
                const tx = parseInt(targetCell.dataset.x);
                const ty = parseInt(targetCell.dataset.y);
                const dist = Math.max(Math.abs(tx - x), Math.abs(ty - y));
                const targetUnit = gameState.board[`${tx}_${ty}`];

                // å¦‚æœæ˜¯å°„ç¨‹å…§çš„æ•µæ–¹å–®ä½ï¼Œé«˜äº®
                if (targetUnit && targetUnit.team !== selectedUnit.team &&
                    targetUnit.type !== 'obstacle' && dist <= range && dist > 0) {
                    targetCell.classList.add('attack-target');
                    targetX = tx;
                    targetY = ty;
                } else if (dist <= range && dist > 0) {
                    // å³ä½¿ä¸æ˜¯æ•µäººï¼Œåªè¦åœ¨ç¯„åœå…§ä¹Ÿé¡¯ç¤ºç·š
                    targetX = tx;
                    targetY = ty;
                }
            }

            // ç¹ªè£½æ”»æ“Šç¯„åœç·šï¼ˆæŒ‡å‘ç›®æ¨™æ ¼å­ä¸­å¿ƒï¼‰
            drawAttackRangeLine(targetX, targetY);
        }

        // ç¹ªè£½æ”»æ“Šç¯„åœç·š
        function drawAttackRangeLine(targetX, targetY) {
            const svg = document.getElementById('attackRangeOverlay');

            // å¦‚æœæ²’æœ‰æœ‰æ•ˆç›®æ¨™ï¼Œæ¸…é™¤ç·šæ¢
            if (targetX === null || targetY === null || !selectedPos) {
                svg.innerHTML = '';
                return;
            }

            const { x, y } = selectedPos;
            const range = UNIT_STATS[selectedUnit.type].rng;

            // æª¢æŸ¥ç›®æ¨™æ˜¯å¦åœ¨å°„ç¨‹å…§ï¼ˆä½¿ç”¨Chebyshev distanceï¼‰
            const dist = Math.max(Math.abs(targetX - x), Math.abs(targetY - y));
            if (dist > range || dist === 0) {
                svg.innerHTML = '';
                return;
            }

            // ç²å–å®¹å™¨å…ƒç´  (SVGæ˜¯ç›¸å°æ–¼æ­¤å®¹å™¨å®šä½çš„)
            const container = document.querySelector('.board-container');

            // ç²å–èµ·é»æ ¼å­ï¼ˆé¸ä¸­å–®ä½ï¼‰
            const selectedCell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (!selectedCell) return;

            // ç²å–ç›®æ¨™æ ¼å­
            const targetCell = document.querySelector(`.cell[data-x="${targetX}"][data-y="${targetY}"]`);
            if (!targetCell) return;

            // ç²å–å®¹å™¨çš„ä½ç½®
            const containerRect = container.getBoundingClientRect();

            // ç²å–å…©å€‹æ ¼å­çš„ä½ç½®
            const startCellRect = selectedCell.getBoundingClientRect();
            const endCellRect = targetCell.getBoundingClientRect();

            // è¨ˆç®—ä¸­å¿ƒé»ï¼ˆç›¸å°æ–¼å®¹å™¨ï¼‰
            const startX = startCellRect.left - containerRect.left + startCellRect.width / 2;
            const startY = startCellRect.top - containerRect.top + startCellRect.height / 2;
            const endX = endCellRect.left - containerRect.left + endCellRect.width / 2;
            const endY = endCellRect.top - containerRect.top + endCellRect.height / 2;

            // ç¹ªè£½SVGç·šï¼ˆå¾é¸ä¸­å–®ä½ä¸­å¿ƒåˆ°ç›®æ¨™æ ¼å­ä¸­å¿ƒï¼‰
            svg.innerHTML = `<line class="attack-range-line" x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" />`;
        }

        // å–æ¶ˆæ“ä½œ
        function cancelAction() {
            actionMode = null;

            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            if (mouseMoveHandler) {
                document.removeEventListener('mousemove', mouseMoveHandler);
                mouseMoveHandler = null;
            }

            const svg = document.getElementById('attackRangeOverlay');
            if (svg) svg.innerHTML = '';

            selectedUnit = null;
            selectedPos = null;
            renderBoard();
        }

        // åŸ·è¡Œç§»å‹•
        async function performMove(tx, ty) {
            const { x, y } = selectedPos;
            const targetUnit = gameState.board[`${tx}_${ty}`];

            let moveType = 'move';
            if (targetUnit && targetUnit.team === selectedUnit.team) {
                moveType = 'swap';
            } else if (Math.abs(tx - x) > 1 || Math.abs(ty - y) > 1) {
                moveType = 'jump';
            }

            const result = gameEngine.executeMove(selectedUnit.id, tx, ty, moveType);

            if (result.success) {
                gameState = gameEngine.state;
                addLog(`${selectedUnit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[selectedUnit.type]} ${result.message} åˆ° (${tx},${ty}) [æ¶ˆè€— ${result.ap_used} AP]`);
                cancelAction();
                updateUI();
            } else {
                alert(result.error);
                cancelAction();
            }
        }

        // åŸ·è¡Œæ”»æ“Š
        async function performAttack(tx, ty) {
            const result = gameEngine.executeAttack(selectedUnit.id, tx, ty);

            if (result.success) {
                gameState = gameEngine.state;

                // è™•ç†æˆ°é¬¥äº‹ä»¶
                result.events.forEach(event => {
                    if (event && event.type === 'damage') {
                        const targetUnit = event.unit_id;
                        const msg = `${selectedUnit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[selectedUnit.type]} æ”»æ“Š (${event.x},${event.y}) é€ æˆ ${event.damage} é»å‚·å®³`;
                        addLog(msg, event.died ? 'death' : 'damage');

                        if (event.died) {
                            addLog(`å–®ä½é™£äº¡ï¼`, 'death');
                        }
                    }
                });

                addLog(`æ¶ˆè€— ${result.ap_used} AP`);

                cancelAction();
                updateUI();

                if (gameState.game_over) {
                    showVictory();
                }
            } else {
                alert(result.error);
                cancelAction();
            }
        }

        // çµæŸå›åˆ
        async function endTurn() {
            cancelAction(); // æ¸…é™¤ä»»ä½•é€²è¡Œä¸­çš„æ“ä½œ

            const result = gameEngine.endTurn();

            if (result.success) {
                gameState = gameEngine.state;
                renderBoard();
                updateUI();
                addLog(`===== å›åˆ ${gameState.turn_count} é–‹å§‹ =====`);
                addLog(`${gameState.current_turn === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} å›åˆé–‹å§‹`);
            }
        }

        // é‡æ–°é–‹å§‹
        function resetGame() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
                cancelAction(); // æ¸…é™¤ä»»ä½•é€²è¡Œä¸­çš„æ“ä½œ
                initGame();
                document.getElementById('logContent').innerHTML = '';
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            const turnIndicator = document.getElementById('turnIndicator');
            const apCounter = document.getElementById('apCounter');

            if (gameState.current_turn === 'red') {
                turnIndicator.textContent = 'ç´…æ–¹å›åˆ';
                turnIndicator.className = 'turn-indicator turn-red';
                apCounter.textContent = `AP: ${gameState.red_ap}`;
            } else {
                turnIndicator.textContent = 'è—æ–¹å›åˆ';
                turnIndicator.className = 'turn-indicator turn-blue';
                apCounter.textContent = `AP: ${gameState.blue_ap}`;
            }
        }

        // é¡¯ç¤ºå‹åˆ©è¨Šæ¯
        function showVictory() {
            const victoryMessage = document.getElementById('victoryMessage');
            const winner = gameState.winner === 'red' ? 'ç´…æ–¹' : 'è—æ–¹';
            victoryMessage.textContent = `ğŸ‰ ${winner} ç²å‹ï¼ğŸ‰`;
            victoryMessage.style.display = 'block';
            addLog(`========== ${winner} ç²å‹ï¼ ==========`, 'death');
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = initGame;
    </script>
</body>

</html>