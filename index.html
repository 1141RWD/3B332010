<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antigravity Tactics</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- å·¦å´é¢æ¿ï¼šå›åˆæŒ‡ç¤º -->
        <div class="side-panel left-panel">
            <div id="turnIndicator" class="turn-indicator turn-red">ç´…æ–¹å›åˆ</div>
            <div id="victoryMessage" class="victory-message" style="display: none;"></div>
        </div>

        <!-- ä¸­é–“é¢æ¿ï¼šæ£‹ç›¤ -->
        <div class="board-container">
            <div id="gameBoard" class="game-board"></div>
            <svg id="attackRangeOverlay" width="100%" height="100%"></svg>
            <!-- ä¸­å¤®æç¤ºè¨Šæ¯ -->
            <div id="centralMessage" class="central-message"></div>
        </div>

        <!-- å³å´é¢æ¿ï¼šç´€éŒ„èˆ‡æ§åˆ¶ -->
        <div class="side-panel right-panel">
            <div class="log-panel">
                <h3>æˆ°é¬¥ç´€éŒ„</h3>
                <div id="logContent" class="log-content"></div>
            </div>

            <div class="controls-area">
                <div id="apCounter" class="ap-counter-bottom">AP: 6</div>
                <div class="controls">
                    <button class="btn-end-turn" onclick="endTurn()">çµæŸå›åˆ</button>
                    <button class="btn-reset" onclick="resetGame()">é‡æ–°é–‹å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="game-logic.js"></script>
    <script>
        const gameEngine = new GameEngine();
        let gameState = null;
        let selectedUnit = null;
        let selectedPos = null;
        let actionMode = null; // null, 'select_action', 'move', 'attack'
        let actionMenu = null;
        let mouseMoveHandler = null;
        let boardRect = null;

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            gameState = gameEngine.initGameState();
            // éš±è—æ‰€æœ‰æç¤ºè¨Šæ¯
            document.getElementById('victoryMessage').style.display = 'none';
            document.getElementById('centralMessage').style.display = 'none';

            renderBoard();
            updateUI();
            addLog('éŠæˆ²é–‹å§‹ï¼ç´…æ–¹å…ˆæ‰‹');
        }

        // æ¸²æŸ“æ£‹ç›¤
        function renderBoard() {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';

            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 13; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    const unit = gameState.board[`${x}_${y}`];

                    if (unit) {
                        if (unit.type === 'obstacle') {
                            cell.classList.add('obstacle');
                            const obstacleImg = document.createElement('img');
                            obstacleImg.className = 'unit-img';
                            obstacleImg.src = 'assets/obstacle.png';
                            obstacleImg.alt = 'éšœç¤™ç‰©';
                            cell.appendChild(obstacleImg);
                        } else {
                            cell.classList.add(unit.team + '-unit');

                            // ä½¿ç”¨åœ–ç‰‡å–ä»£æ–‡å­—å­—å…ƒ
                            const unitImg = document.createElement('img');
                            unitImg.className = 'unit-img';
                            unitImg.src = `assets/${unit.type}.png`;
                            unitImg.alt = UNIT_NAMES[unit.type];
                            // åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚å›é€€åˆ°æ–‡å­—
                            unitImg.onerror = function () {
                                this.style.display = 'none';
                                const fallbackText = document.createElement('div');
                                fallbackText.className = 'unit-type';
                                fallbackText.textContent = UNIT_NAMES[unit.type];
                                cell.insertBefore(fallbackText, cell.firstChild);
                            };

                            const unitHP = document.createElement('div');
                            unitHP.className = 'unit-hp';
                            unitHP.textContent = `${unit.hp}/${unit.max_hp}`;

                            const hpBar = document.createElement('div');
                            hpBar.className = 'hp-bar';
                            const hpFill = document.createElement('div');
                            hpFill.className = 'hp-fill';
                            hpFill.style.width = `${(unit.hp / unit.max_hp) * 100}%`;
                            hpBar.appendChild(hpFill);

                            cell.appendChild(unitImg);
                            cell.appendChild(unitHP);
                            cell.appendChild(hpBar);

                            // é¡¯ç¤ºç‚®çš„å†·å»ç‹€æ…‹
                            if (unit.type === 'can' && unit.cooldown > 0) {
                                const cooldownIndicator = document.createElement('div');
                                cooldownIndicator.className = 'cooldown-indicator';
                                cooldownIndicator.textContent = `å†·å»:${unit.cooldown}`;
                                cell.appendChild(cooldownIndicator);
                            }
                        }
                    }

                    cell.onclick = () => handleCellClick(x, y);
                    board.appendChild(cell);
                }
            }
        }

        // è™•ç†æ ¼å­é»æ“Š
        async function handleCellClick(x, y) {
            if (gameState.game_over) {
                alert('éŠæˆ²å·²çµæŸï¼');
                return;
            }

            const unit = gameState.board[`${x}_${y}`];

            // ç§»å‹•æ¨¡å¼ï¼šé»æ“Šç¶ è‰²æ ¼å­ç§»å‹•ï¼Œå…¶ä»–å–æ¶ˆ
            if (actionMode === 'move') {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell.classList.contains('move-highlight')) {
                    await performMove(x, y);
                } else {
                    cancelAction();
                    addLog('å–æ¶ˆç§»å‹•');
                }
                return;
            }

            // æ”»æ“Šæ¨¡å¼ï¼šé»æ“Šç›®æ¨™æ”»æ“Šï¼Œå…¶ä»–å–æ¶ˆ
            if (actionMode === 'attack') {
                const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                if (cell.classList.contains('attack-target')) {
                    await performAttack(x, y);
                } else {
                    cancelAction();
                    addLog('å–æ¶ˆæ”»æ“Š');
                }
                return;
            }

            // é»æ“Šå·±æ–¹å–®ä½ -> é¡¯ç¤ºæ“ä½œé¸å–®
            if (unit && unit.team === gameState.current_turn && unit.type !== 'obstacle') {
                selectedUnit = unit;
                selectedPos = { x, y };
                showActionMenu(x, y);
                addLog(`é¸æ“‡äº† ${unit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[unit.type]} (${x},${y})`);
                return;
            }

            // é»æ“Šå…¶ä»–åœ°æ–¹å–æ¶ˆé¸æ“‡
            if (selectedUnit || actionMode) {
                cancelAction();
            }
        }

        // é¡¯ç¤ºæ“ä½œé¸å–®
        function showActionMenu(x, y) {
            // åªæ¸…é™¤æ“ä½œç‹€æ…‹ï¼Œä¸æ¸…é™¤é¸ä¸­çš„å–®ä½ä¿¡æ¯
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }
            if (mouseMoveHandler) {
                document.removeEventListener('mousemove', mouseMoveHandler);
                mouseMoveHandler = null;
            }
            const svg = document.getElementById('attackRangeOverlay');
            if (svg) svg.innerHTML = '';
            document.querySelectorAll('.move-highlight, .attack-target, .splash-target').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target', 'splash-target');
            });

            actionMode = 'select_action';
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // å‰µå»ºé¸å–®
            actionMenu = document.createElement('div');
            actionMenu.className = 'action-menu';

            // é¡¯ç¤ºå–®ä½åç¨±
            const title = document.createElement('div');
            title.className = 'action-menu-title';
            title.textContent = UNIT_NAMES[selectedUnit.type];
            actionMenu.appendChild(title);

            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '10px';
            btnContainer.style.justifyContent = 'center';

            const moveBtn = document.createElement('button');
            moveBtn.className = 'action-btn action-btn-move';
            moveBtn.textContent = 'ç§»å‹•';
            moveBtn.onclick = (e) => {
                e.stopPropagation();
                enterMoveMode();
            };

            const attackBtn = document.createElement('button');
            attackBtn.className = 'action-btn action-btn-attack';
            attackBtn.textContent = 'æ”»æ“Š';
            attackBtn.onclick = (e) => {
                e.stopPropagation();
                // æª¢æŸ¥ç‚®æ˜¯å¦è™•æ–¼å†·å»ä¸­
                if (selectedUnit.type === 'can' && selectedUnit.cooldown > 0) {
                    alert(`ç‚®è™•æ–¼å†·å»ä¸­ (å‰©é¤˜ ${selectedUnit.cooldown} å›åˆ)`);
                    return;
                }
                enterAttackMode();
            };

            btnContainer.appendChild(moveBtn);
            btnContainer.appendChild(attackBtn);
            actionMenu.appendChild(btnContainer);

            // å®šä½é¸å–®
            const boardContainer = document.querySelector('.board-container');
            const cellRect = cell.getBoundingClientRect();
            const containerRect = boardContainer.getBoundingClientRect();

            actionMenu.style.left = (cellRect.left - containerRect.left + cellRect.width / 2 - 80) + 'px';
            actionMenu.style.top = (cellRect.top - containerRect.top - 50) + 'px';

            boardContainer.appendChild(actionMenu);
        }

        // é€²å…¥ç§»å‹•æ¨¡å¼
        function enterMoveMode() {
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            actionMode = 'move';

            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´å€‹æ£‹ç›¤ï¼‰
            document.querySelectorAll('.move-highlight, .attack-target, .splash-target, .selected').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target', 'splash-target', 'selected');
            });

            const { x, y } = selectedPos;
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // è¨ˆç®—èŠ±è²»1APå¯é”çš„æ ¼å­
            const currentAP = gameState.current_turn === 'red' ? gameState.red_ap : gameState.blue_ap;
            const apMove = UNIT_STATS[selectedUnit.type].ap_move;

            if (currentAP < apMove) {
                addLog('APä¸è¶³ï¼Œç„¡æ³•ç§»å‹•');
                cancelAction();
                return;
            }

            let highlightCount = 0;

            // 1. é«˜äº®ç›¸é„°8æ ¼ï¼ˆåŸºæœ¬ç§»å‹•ï¼‰
            for (let dx = -1; dx <= 1; dx++) {
                for (let dy = -1; dy <= 1; dy++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx >= 0 && nx < 13 && ny >= 0 && ny < 15) {
                        const targetUnit = gameState.board[`${nx}_${ny}`];
                        // ç©ºæ ¼å¯ç§»å‹•ï¼ˆ1APï¼‰ï¼Œå‹æ–¹å¯äº¤æ›ï¼ˆéœ€2APä½†å…ˆé¡¯ç¤ºï¼‰
                        if (!targetUnit || (targetUnit.team === selectedUnit.team && targetUnit.type !== 'obstacle')) {
                            const targetCell = document.querySelector(`.cell[data-x="${nx}"][data-y="${ny}"]`);
                            if (targetCell) {
                                targetCell.classList.add('move-highlight');
                                highlightCount++;
                            }
                        }
                    }
                }
            }

            // 2. é«˜äº®è·³èºç§»å‹•ï¼ˆè·³åˆ°ç›´ç·šä¸Šé€£çºŒå‹æ–¹å–®ä½çš„å‰æ–¹ä¸€æ ¼ï¼Œæœ€å¤šè·³é3å€‹ï¼‰
            const jumpDirections = [
                { dx: 0, dy: 1, name: 'ä¸‹' },
                { dx: 0, dy: -1, name: 'ä¸Š' },
                { dx: 1, dy: 0, name: 'å³' },
                { dx: -1, dy: 0, name: 'å·¦' }
            ];

            for (let dir of jumpDirections) {
                // æ²¿è‘—é€™å€‹æ–¹å‘å°‹æ‰¾é€£çºŒçš„å‹æ–¹å–®ä½ï¼ˆæœ€å¤š3å€‹ï¼‰
                let consecutiveAllies = 0;
                let checkX = x + dir.dx;
                let checkY = y + dir.dy;

                // è¨ˆç®—é€£çºŒçš„å‹æ–¹å–®ä½æ•¸é‡ï¼ˆæœ€å¤š3å€‹ï¼‰
                while (checkX >= 0 && checkX < 13 && checkY >= 0 && checkY < 15 && consecutiveAllies < 3) {
                    const checkUnit = gameState.board[`${checkX}_${checkY}`];
                    if (checkUnit && checkUnit.team === selectedUnit.team && checkUnit.type !== 'obstacle') {
                        consecutiveAllies++;
                        checkX += dir.dx;
                        checkY += dir.dy;
                    } else {
                        break;
                    }
                }

                // å¦‚æœæœ‰é€£çºŒçš„å‹æ–¹å–®ä½ï¼Œè·³åˆ°ä»–å€‘çš„å‰æ–¹ä¸€æ ¼
                if (consecutiveAllies > 0) {
                    // checkX, checkY ç¾åœ¨å·²ç¶“æ˜¯æœ€å¾Œä¸€å€‹å‹æ–¹å–®ä½çš„ä¸‹ä¸€æ ¼
                    if (checkX >= 0 && checkX < 13 && checkY >= 0 && checkY < 15) {
                        const targetUnit = gameState.board[`${checkX}_${checkY}`];
                        // ç›®æ¨™ä½ç½®å¿…é ˆç‚ºç©º
                        if (!targetUnit) {
                            const targetCell = document.querySelector(`.cell[data-x="${checkX}"][data-y="${checkY}"]`);
                            if (targetCell && !targetCell.classList.contains('move-highlight')) {
                                targetCell.classList.add('move-highlight');
                                highlightCount++;
                            }
                        }
                    }
                }
            }

            addLog('ç§»å‹•æ¨¡å¼ï¼šé»æ“Šç¶ è‰²æ ¼å­ç§»å‹•ï¼ˆå«è·³èºï¼‰');
        }

        // é€²å…¥æ”»æ“Šæ¨¡å¼
        function enterAttackMode() {
            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            actionMode = 'attack';

            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´å€‹æ£‹ç›¤ï¼‰
            document.querySelectorAll('.move-highlight, .attack-target, .splash-target, .selected').forEach(el => {
                el.classList.remove('move-highlight', 'attack-target', 'splash-target', 'selected');
            });

            const { x, y } = selectedPos;
            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (cell) cell.classList.add('selected');

            // æ›´æ–°æ£‹ç›¤rect
            const board = document.getElementById('gameBoard');
            boardRect = board.getBoundingClientRect();

            // æ·»åŠ é¼ æ¨™ç§»å‹•ç›£è½
            mouseMoveHandler = (e) => handleMouseMoveInAttackMode(e);
            document.addEventListener('mousemove', mouseMoveHandler);

            addLog('æ”»æ“Šæ¨¡å¼ï¼šç§»å‹•é¼ æ¨™ç„æº–ç›®æ¨™');
        }

        // è™•ç†æ”»æ“Šæ¨¡å¼ä¸‹çš„é¼ æ¨™ç§»å‹•
        function handleMouseMoveInAttackMode(e) {
            if (actionMode !== 'attack' || !selectedPos) return;

            // æ¯æ¬¡éƒ½é‡æ–°ç²å–boardRectï¼Œä»¥è™•ç†æ»¾å‹•
            const board = document.getElementById('gameBoard');
            boardRect = board.getBoundingClientRect();

            const { x, y } = selectedPos;
            const range = UNIT_STATS[selectedUnit.type].rng;

            // æª¢æ¸¬é¼ æ¨™ä¸‹çš„ç›®æ¨™æ ¼å­
            const cells = document.elementsFromPoint(e.clientX, e.clientY);
            const targetCell = cells.find(el => el.classList.contains('cell'));

            // æ¸…é™¤ä¹‹å‰çš„ç›®æ¨™é«˜äº®
            document.querySelectorAll('.attack-target, .splash-target').forEach(el => {
                el.classList.remove('attack-target', 'splash-target');
            });

            // é«˜äº®é‚è¼¯
            if (targetCell) {
                const tx = parseInt(targetCell.dataset.x);
                const ty = parseInt(targetCell.dataset.y);
                const dist = Math.max(Math.abs(tx - x), Math.abs(ty - y));
                const targetUnit = gameState.board[`${tx}_${ty}`];

                // å¦‚æœæ˜¯å°„ç¨‹å…§çš„æ•µæ–¹å–®ä½ï¼Œé«˜äº®
                if (targetUnit && targetUnit.team !== selectedUnit.team &&
                    targetUnit.type !== 'obstacle' && dist <= range && dist > 0) {
                    targetCell.classList.add('attack-target'); // ä¸»è¦ç›®æ¨™

                    // æ¿ºå°„å‚·å®³æª¢æŸ¥ (Mage æˆ– Can)
                    if (selectedUnit.type === 'mage' || selectedUnit.type === 'can') {
                        // 3x3 æ¿ºå°„
                        for (let dx = -1; dx <= 1; dx++) {
                            for (let dy = -1; dy <= 1; dy++) {
                                const sx = tx + dx;
                                const sy = ty + dy;
                                if (sx >= 0 && sx < 13 && sy >= 0 && sy < 15) {
                                    const splashCell = document.querySelector(`.cell[data-x="${sx}"][data-y="${sy}"]`);
                                    if (splashCell && (dx !== 0 || dy !== 0)) {
                                        splashCell.classList.add('splash-target');
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // ç¹ªè£½å‹•æ…‹æ”»æ“Šç·š (è·Ÿéš¨é¼ æ¨™)
            drawDynamicAttackLine(e.clientX, e.clientY);
        }

        // ç¹ªè£½å‹•æ…‹æ”»æ“Šç¯„åœç·š
        function drawDynamicAttackLine(mouseX, mouseY) {
            const svg = document.getElementById('attackRangeOverlay');
            if (!selectedPos) {
                svg.innerHTML = '';
                return;
            }

            const { x, y } = selectedPos;
            const range = UNIT_STATS[selectedUnit.type].rng;

            // ç²å–å®¹å™¨å’Œæ£‹ç›¤è³‡è¨Š
            const container = document.querySelector('.board-container');
            const containerRect = container.getBoundingClientRect();

            // ç²å–èµ·é»æ ¼å­ï¼ˆé¸ä¸­å–®ä½ï¼‰
            const selectedCell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
            if (!selectedCell) return;
            const startRect = selectedCell.getBoundingClientRect();

            // è¨ˆç®—èµ·é»ä¸­å¿ƒï¼ˆç›¸å°æ–¼å®¹å™¨ï¼‰
            const startX = startRect.left - containerRect.left + startRect.width / 2;
            const startY = startRect.top - containerRect.top + startRect.height / 2;

            // è¨ˆç®—é¼ æ¨™ä½ç½®ï¼ˆç›¸å°æ–¼å®¹å™¨ï¼‰
            let endX = mouseX - containerRect.left;
            let endY = mouseY - containerRect.top;

            // è¨ˆç®—ç›¸å°æ–¼èµ·é»çš„å‘é‡
            let dx = endX - startX;
            let dy = endY - startY;

            // è¨ˆç®—æ ¼å­å¤§å° (è¿‘ä¼¼å€¼)
            const cellWidth = startRect.width;
            const cellHeight = startRect.height; // Should be same as width

            // å°‡åƒç´ è·é›¢è½‰æ›ç‚º"é‚è¼¯è·é›¢" (Chebyshev)
            // é€™è£¡æˆ‘å€‘ç”¨ç°¡å–®çš„æ¯”ä¾‹æ”¾å¤§ï¼šå¦‚æœæ»‘é¼ è¶…éäº† (range * cellWidth) çš„æ–¹å½¢é‚Šç•Œï¼Œå°±æˆªæ–·
            // è€ƒæ…®åˆ° Chebyshev è·é›¢æ˜¯æ–¹å½¢æ“´æ•£ï¼Œæˆ‘å€‘åˆ†åˆ¥é™åˆ¶ X å’Œ Y è»¸

            // å…è¨±ç¨å¾®è¶…å‡ºæ ¼å­ä¸­å¿ƒåˆ°é‚Šç·£çš„è·é›¢ï¼Œæ‰€ä»¥ç”¨ range + 0.5 (è¦†è“‹æ•´å€‹ç›®æ¨™æ ¼)
            // æˆ–è€…åš´æ ¼ä¸€é»ï¼Œåªå…è¨±é€£ç·šåˆ° range åŠå¾‘çš„é‚Šç·£
            const maxDistPixels = (range * cellWidth) + (cellWidth * 0.5); // è®“ç·šé ­èƒ½ç¢°åˆ°æœ€é æ ¼å­çš„ä¸­å¿ƒç”šè‡³é‚Šç·£

            // è¨ˆç®—ç›®å‰çš„ Chebyshev åƒç´ è·é›¢
            // æˆ‘å€‘å¸Œæœ›é™åˆ¶åœ¨ä»¥ start ç‚ºä¸­å¿ƒçš„æ–¹å½¢å€åŸŸå…§
            // æ–¹å½¢é‚Šé•·åŠå¾‘ = range * cellWidth (å¤§ç´„)

            // æ›´åŠ ç²¾ç¢ºçš„ç®—æ³•ï¼š
            // å¦‚æœæˆ‘å€‘æŠŠ dx, dy æ­£è¦åŒ–åˆ° "æ ¼å­å–®ä½"
            const gridDx = dx / cellWidth;
            const gridDy = dy / cellHeight;

            // Chebyshev magnitude
            const magnitude = Math.max(Math.abs(gridDx), Math.abs(gridDy));

            if (magnitude > range) {
                // éœ€è¦ç¸®çŸ­
                const scale = range / magnitude;
                dx *= scale;
                dy *= scale;
                endX = startX + dx;
                endY = startY + dy;
            }

            // ç¹ªè£½SVGç·š
            svg.innerHTML = `<line class="attack-range-line" x1="${startX}" y1="${startY}" x2="${endX}" y2="${endY}" />`;
        }

        // å–æ¶ˆæ“ä½œ
        function cancelAction() {
            actionMode = null;

            if (actionMenu) {
                actionMenu.remove();
                actionMenu = null;
            }

            if (mouseMoveHandler) {
                document.removeEventListener('mousemove', mouseMoveHandler);
                mouseMoveHandler = null;
            }

            const svg = document.getElementById('attackRangeOverlay');
            if (svg) svg.innerHTML = '';

            selectedUnit = null;
            selectedPos = null;
            renderBoard();
        }

        // åŸ·è¡Œç§»å‹•
        async function performMove(tx, ty) {
            const { x, y } = selectedPos;
            const targetUnit = gameState.board[`${tx}_${ty}`];

            let moveType = 'move';
            if (targetUnit && targetUnit.team === selectedUnit.team) {
                moveType = 'swap';
            } else if (Math.abs(tx - x) > 1 || Math.abs(ty - y) > 1) {
                moveType = 'jump';
            }

            const result = gameEngine.executeMove(selectedUnit.id, tx, ty, moveType);

            if (result.success) {
                gameState = gameEngine.state;
                addLog(`${selectedUnit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[selectedUnit.type]} ${result.message} åˆ° (${tx},${ty}) [æ¶ˆè€— ${result.ap_used} AP]`);
                cancelAction();
                updateUI();

                // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•æ›å›åˆ
                if (result.auto_turn_end) {
                    setTimeout(() => {
                        endTurn(true); // å‚³å…¥ true è¡¨ç¤ºè‡ªå‹•æ›å›åˆ
                    }, 500);
                }
            } else {
                alert(result.error);
                cancelAction();
            }
        }

        // åŸ·è¡Œæ”»æ“Š
        async function performAttack(tx, ty) {
            const result = gameEngine.executeAttack(selectedUnit.id, tx, ty);

            if (result.success) {
                gameState = gameEngine.state;

                // è™•ç†æˆ°é¬¥äº‹ä»¶
                result.events.forEach(event => {
                    if (event && event.type === 'damage') {
                        const targetUnit = event.unit_id;
                        const protectedTag = event.protected ? ' [å°‡è»ä¿è­·]' : '';
                        const msg = `${selectedUnit.team === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} ${UNIT_NAMES[selectedUnit.type]} æ”»æ“Š (${event.x},${event.y}) é€ æˆ ${event.damage} é»å‚·å®³${protectedTag}`;
                        addLog(msg, event.died ? 'death' : 'damage');

                        if (event.died) {
                            addLog(`å–®ä½é™£äº¡ï¼`, 'death');
                        }
                    }
                });

                addLog(`æ¶ˆè€— ${result.ap_used} AP`);

                cancelAction();
                updateUI();

                if (gameState.game_over) {
                    showVictory();
                } else if (result.auto_turn_end) {
                    // è‡ªå‹•æ›å›åˆ
                    setTimeout(() => {
                        endTurn(true); // å‚³å…¥ true è¡¨ç¤ºè‡ªå‹•æ›å›åˆ
                    }, 500);
                }
            } else {
                alert(result.error);
                cancelAction();
            }
        }

        // çµæŸå›åˆ
        async function endTurn(isAuto = false) {
            cancelAction(); // æ¸…é™¤ä»»ä½•é€²è¡Œä¸­çš„æ“ä½œ

            const result = gameEngine.endTurn();

            if (result.success) {
                gameState = gameEngine.state;
                renderBoard();
                updateUI();
                addLog(`===== å›åˆ ${gameState.turn_count} é–‹å§‹ =====`);
                addLog(`${gameState.current_turn === 'red' ? 'ç´…æ–¹' : 'è—æ–¹'} å›åˆé–‹å§‹`);

                // é¡¯ç¤ºä¸­å¤®æç¤ºè¨Šæ¯
                const turnText = gameState.current_turn === 'red' ? 'ç´…æ–¹å›åˆ' : 'è—æ–¹å›åˆ';
                showCentralMessage(turnText, 'turn');
            }
        }

        // é‡æ–°é–‹å§‹
        function resetGame() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ')) {
                cancelAction(); // æ¸…é™¤ä»»ä½•é€²è¡Œä¸­çš„æ“ä½œ
                initGame();
                document.getElementById('logContent').innerHTML = '';
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            const turnIndicator = document.getElementById('turnIndicator');
            const apCounter = document.getElementById('apCounter');

            if (gameState.current_turn === 'red') {
                turnIndicator.textContent = 'ç´…æ–¹å›åˆ';
                turnIndicator.className = 'turn-indicator turn-red';
                apCounter.textContent = `AP: ${gameState.red_ap}`;
            } else {
                turnIndicator.textContent = 'è—æ–¹å›åˆ';
                turnIndicator.className = 'turn-indicator turn-blue';
                apCounter.textContent = `AP: ${gameState.blue_ap}`;
            }
        }

        // é¡¯ç¤ºå‹åˆ©è¨Šæ¯
        function showVictory() {
            const victoryMessage = document.getElementById('victoryMessage');
            const winner = gameState.winner === 'red' ? 'ç´…æ–¹' : 'è—æ–¹';
            victoryMessage.textContent = `ğŸ‰ ${winner} ç²å‹ï¼ğŸ‰`;
            victoryMessage.style.display = 'block';
            addLog(`========== ${winner} ç²å‹ï¼ ==========`, 'death');

            // é¡¯ç¤ºä¸­å¤®æç¤ºè¨Šæ¯
            showCentralMessage(`${winner} å‹åˆ©ï¼`, 'victory');
        }

        // é¡¯ç¤ºä¸­å¤®æç¤ºè¨Šæ¯
        function showCentralMessage(text, type) {
            const messageDiv = document.getElementById('centralMessage');
            messageDiv.textContent = text;
            messageDiv.className = `central-message ${type}`;
            messageDiv.style.display = 'flex';

            // 2ç§’å¾Œè‡ªå‹•éš±è—ï¼ˆå‹åˆ©è¨Šæ¯é™¤å¤–ï¼‰
            if (type !== 'victory') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 2000);
            }
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = message;
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = initGame;
    </script>
</body>

</html>